services:
  agor-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    # No container_name - allows multiple instances via docker compose -p flag
    ports:
      # Expose daemon port (so browser can connect) - configurable via DAEMON_PORT
      - '${DAEMON_PORT:-3030}:${DAEMON_PORT:-3030}'
      # Expose UI port (configurable via UI_PORT env var)
      - '${UI_PORT:-5173}:${UI_PORT:-5173}'
    environment:
      # Daemon configuration
      - NODE_ENV=development
      - DAEMON_PORT=${DAEMON_PORT:-3030}
      - CORS_ORIGIN=${CORS_ORIGIN:-}

      # UI configuration
      - UI_PORT=${UI_PORT:-5173}
      # UI connects to daemon via localhost (inside container)
      - VITE_DAEMON_PORT=${DAEMON_PORT:-3030}

      # Pass through API keys from host (if set)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
    volumes:
      # Mount entire repo for hot-reload (but exclude node_modules)
      - .:/app
      # Exclude all node_modules directories (use container's versions)
      - /app/node_modules
      - /app/apps/agor-daemon/node_modules
      - /app/apps/agor-cli/node_modules
      - /app/apps/agor-ui/node_modules
      - /app/packages/core/node_modules
      # Persist entire home directory (database, config, agent auth tokens, etc.)
      - agor-home:/home/agor
      # Mount SSH keys for git authentication (dev only)
      - ~/.ssh:/home/agor/.ssh:ro
    stdin_open: true
    tty: true

volumes:
  # Named volume - unique per docker-compose project
  # Use -p flag to create separate volumes per worktree
  # Persists: database, config, agent auth tokens, caches, etc.
  agor-home:
