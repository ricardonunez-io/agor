# Agor Shell Pod Dockerfile
# Minimal image for isolated terminal sessions
#
# Contains:
# - Zellij (terminal multiplexer)
# - Docker CLI (standalone binary, connects to DOCKER_HOST)
# - Claude Code (AI agent)
# - Git, vi, basic tools

FROM debian:bookworm-slim

ARG TARGETARCH

# Install minimal runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Version control
    git \
    # Networking (for downloads and debugging)
    curl \
    ca-certificates \
    # SSH server (for sshd sidecar)
    openssh-server \
    # Shell
    bash \
    # Editor
    vim-tiny \
    # Basic tools
    jq \
    procps \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && mkdir -p /run/sshd

# Install Docker CLI only (standalone binary, ~50MB vs ~300MB for docker.io)
RUN ARCH=$(case "${TARGETARCH}" in \
        "amd64") echo "x86_64" ;; \
        "arm64") echo "aarch64" ;; \
        *) echo "x86_64" ;; \
    esac) && \
    curl -fsSL "https://download.docker.com/linux/static/stable/${ARCH}/docker-24.0.7.tgz" \
    | tar -xz --strip-components=1 -C /usr/local/bin docker/docker && \
    chmod +x /usr/local/bin/docker

# Install docker-compose v2 (standalone)
RUN ARCH=$(case "${TARGETARCH}" in \
        "amd64") echo "x86_64" ;; \
        "arm64") echo "aarch64" ;; \
        *) echo "x86_64" ;; \
    esac) && \
    curl -fsSL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-${ARCH}" \
    -o /usr/local/bin/docker-compose && \
    chmod +x /usr/local/bin/docker-compose

# Install Zellij (terminal multiplexer)
RUN ARCH=$(case "${TARGETARCH}" in \
        "amd64") echo "x86_64" ;; \
        "arm64") echo "aarch64" ;; \
        *) echo "x86_64" ;; \
    esac) && \
    curl -fsSL "https://github.com/zellij-org/zellij/releases/latest/download/zellij-${ARCH}-unknown-linux-musl.tar.gz" \
    | tar -xz -C /usr/local/bin && \
    chmod +x /usr/local/bin/zellij

# Install Node.js 22 LTS (required for Claude Code) - minimal install
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - && \
    apt-get install -y --no-install-recommends nodejs && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    npm cache clean --force

# Install Claude Code
RUN npm install -g @anthropic-ai/claude-code && \
    npm cache clean --force

# Create default user (init container creates actual users)
RUN groupadd -g 1000 agor && \
    useradd -u 1000 -g 1000 -m -s /bin/bash agor && \
    mkdir -p /home/agor/.agor /home/agor/.config/zellij

# Minimal bashrc
RUN echo 'export PS1="\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ "' > /home/agor/.bashrc && \
    echo 'export EDITOR=vi' >> /home/agor/.bashrc && \
    echo 'alias vi=vim.tiny' >> /home/agor/.bashrc && \
    echo 'alias d=docker' >> /home/agor/.bashrc && \
    echo 'alias dc=docker-compose' >> /home/agor/.bashrc && \
    chown -R agor:agor /home/agor

# Minimal Zellij config
RUN echo 'default_shell "bash"' > /home/agor/.config/zellij/config.kdl && \
    echo 'pane_frames false' >> /home/agor/.config/zellij/config.kdl && \
    chown -R agor:agor /home/agor/.config

ENV HOME=/home/agor
ENV USER=agor
ENV SHELL=/bin/bash

USER agor
WORKDIR /home/agor

CMD ["sleep", "infinity"]
