# Development values for Agor
# Usage: helm install agor ./helm/agor -f helm/values-dev.yaml

# Database: PostgreSQL
database:
  type: postgresql
  existingSecret: postgres-credentials

# Use ECR images
daemon:
  # Symlink for path compatibility with local dev (e.g., /home/agorpg -> /home/agor)
  homeSymlink: agorpg

  # Force pod restart on every helm upgrade (picks up new images)
  forceRollout: true

  image:
    repository: public.ecr.aws/a5v0t1w0/agor/daemon
    tag: dev
    pullPolicy: Always

  # Smaller resources for dev
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Dev configuration
  config:
    daemon:
      port: 3030
      requireAuth: true
      allowAnonymous: false
    execution:
      worktree_rbac: false
      unix_user_mode: opportunistic
      terminal_mode: pod  # Use isolated shell pods instead of daemon
      unix_uid_range:
        min: 10000
        max: 60000
      user_pods:
        enabled: true
        shellPod:
          image: public.ecr.aws/a5v0t1w0/agor/shell:dev
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: "1"
              memory: 1Gi
          sshdResources:
            requests:
              cpu: 50m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
        podmanPod:
          image: public.ecr.aws/a5v0t1w0/agor/podman:dev
          initImage: busybox:1.36
          resources:
            requests:
              cpu: 100m
              memory: 512Mi
            limits:
              cpu: "2"
              memory: 3Gi
        storage:
          dataPvc: agor-data-nfs
        appBaseDomain: agor-k8s.sandbox.preset.zone
        ingressClassName: traefik
        sshEntryPoint: ssh

  # User Pods configuration (for terminal_mode: pod)
  userPods:
    enabled: true
    shellPod:
      image: public.ecr.aws/a5v0t1w0/agor/shell:dev
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          cpu: "1"
          memory: 1Gi
      sshdResources:
        requests:
          cpu: 50m
          memory: 256Mi
        limits:
          cpu: 500m
          memory: 512Mi
    podmanPod:
      image: public.ecr.aws/a5v0t1w0/agor/podman:dev
      initImage: busybox:1.36
      resources:
        requests:
          cpu: 100m
          memory: 512Mi
        limits:
          cpu: "4"
          memory: 6Gi
    storage:
      dataPvc: agor-data-nfs
    appBaseDomain: agor-k8s.sandbox.preset.zone
    ingressClassName: traefik
    sshEntryPoint: ssh

  # Skip admin bootstrap - using external PostgreSQL
  skipAdminBootstrap: true

  # Skip migrations on startup (run manually when schema changes)
  skipMigrations: true

  # Extra environment variables
  extraEnv:
    - name: GITHUB_TOKEN
      valueFrom:
        secretKeyRef:
          name: agor-github-token
          key: token

  # Enable persistence with NFS PVCs
  persistence:
    enabled: true
    storageClass: nfs
    home:
      existingClaim: agor-home-nfs
    data:
      existingClaim: agor-data-nfs

ui:
  image:
    repository: public.ecr.aws/a5v0t1w0/agor/ui
    tag: dev
    pullPolicy: Always

  resources:
    requests:
      cpu: 25m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 64Mi

# Enable ingress
ingress:
  enabled: true
  className: traefik
  annotations:
    # WebSocket support for Traefik
    traefik.ingress.kubernetes.io/router.middlewares: ""
  hosts:
    # Main domain
    - host: agor-k8s.sandbox.preset.zone
      paths:
        - path: /
          pathType: Prefix
          service: ui
        - path: /health
          pathType: Prefix
          service: daemon
        - path: /socket.io
          pathType: Prefix
          service: daemon
        - path: /users
          pathType: Prefix
          service: daemon
        - path: /sessions
          pathType: Prefix
          service: daemon
        - path: /tasks
          pathType: Prefix
          service: daemon
        - path: /messages
          pathType: Prefix
          service: daemon
        - path: /worktrees
          pathType: Prefix
          service: daemon
        - path: /repos
          pathType: Prefix
          service: daemon
        - path: /boards
          pathType: Prefix
          service: daemon
        - path: /board-objects
          pathType: Prefix
          service: daemon
        - path: /terminals
          pathType: Prefix
          service: daemon
        - path: /auth
          pathType: Prefix
          service: daemon

# Disable security context for local dev (simpler)
podSecurityContext: {}
securityContext: {}
